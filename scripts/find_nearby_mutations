from Bio.PDB import MMCIFParser
import numpy as np
from pathlib import Path

parser = MMCIFParser(QUIET=True)
SCRIPT_DIR = Path(__file__).parent
PROJECT_ROOT = SCRIPT_DIR.parent
model_file = PROJECT_ROOT / "AlphaFold_models" / "P35222" / "P35222_model_0.cif" #change to be path to desired .cif file
structure = parser.get_structure("protein", model_file)

model = structure[0]   # First (and only) model
chain = list(model.get_chains())[0]  # AlphaFold usually has one chain

def get_ca_coord(chain, residue_number):
    """
    Returns CA coordinates for a given residue number.
    """
    for residue in chain:
        if residue.get_id()[1] == residue_number:
            if "CA" in residue:
                return residue["CA"].get_coord()
    return None

#compute distance between two 3D points
def compute_distance(coord1, coord2):
    return np.linalg.norm(coord1 - coord2)

#find mutations within cutoff distance of PTM site
def find_nearby_mutations(chain, ptm_pos, mutation_positions, cutoff=10.0): #adjust cutoff as needed
    """
    Returns list of mutations within cutoff Å of PTM site.
    """
    results = []

    ptm_coord = get_ca_coord(chain, ptm_pos)

    if ptm_coord is None:
        print(f"PTM residue {ptm_pos} not found in structure.")
        return results

    for mut_pos in mutation_positions:
        mut_coord = get_ca_coord(chain, mut_pos)

        if mut_coord is None:
            continue

        distance = compute_distance(ptm_coord, mut_coord)

        if distance <= cutoff:
            results.append({
                "mutation_pos": mut_pos,
                "distance": distance
            })

    return results

def parse_mutation_pos(): # Placeholder for mutation position parsing logic
    results = []
    return results

ptm_position = 298 #change to be position of PTM site of interest
mutation_positions = list(range(1, 2000)) #change to be list of mutation positions of interest, currently set to all positions in typical protein length range for demonstration

nearby = find_nearby_mutations(chain, ptm_position, mutation_positions)

#final output of program
for hit in nearby:
    print(f"Mutation at {hit['mutation_pos']} is {hit['distance']:.2f} Å away")